<!DOCTYPE html>
<html lang="en" data-theme="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paraffin Log Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-body: #121212;
            --color-text-primary: #e2e8f0;
            --color-text-heading: #ffffff;
            --bg-container: #2d3748;
            --border-input: #4a5568;
            --bg-input: #1a202c;
            --border-focus: #667eea;
            --shadow-focus: rgba(102, 126, 234, 0.3);
            --bg-button-primary: #667eea;
            --bg-button-primary-hover: #5a67d8;
            --shadow-button-primary: rgba(102, 126, 234, 0.4);
            --shadow-button-primary-hover: rgba(102, 126, 234, 0.5);
            --bg-message-success: #2d6a4f;
            --bg-message-error: #9b2c2c;
            --bg-table-header: #4a5568;
            --color-table-header: #cbd5e1;
            --bg-table-row-even: #2d3748;
            --bg-table-row-hover: #4a5568;
            --bg-modal: #1a202c;
            --color-modal-heading: #ffffff;
            --color-modal-text: #e2e8f0;
            --bg-confirm-btn: #c53030;
            --bg-confirm-btn-hover: #a02020;
            --shadow-confirm-btn: rgba(197, 48, 48, 0.4);
            --shadow-confirm-btn-hover: rgba(197, 48, 48, 0.5);
            --bg-cancel-btn: #4a5568;
            --color-cancel-btn: #e2e8f0;
            --shadow-cancel-btn: rgba(74, 85, 104, 0.3);
            --shadow-cancel-btn-hover: rgba(74, 85, 104, 0.4);
            --bg-user-info: #4a5568;
            --color-user-info: #e2e8f0;
        }
        body {
            background: var(--bg-body);
            color: var(--color-text-primary);
        }
        .container {
            background-color: var(--bg-container);
            padding: 16px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 1200px;
            margin: 16px auto;
        }
        @media (min-width: 768px) {
            .container {
                padding: 32px;
                margin-top: 30px;
                margin-bottom: 30px;
            }
        }
        h1, h2 {
            color: var(--color-text-heading);
        }
        input, select {
            border-color: var(--border-input);
            background-color: var(--bg-input);
            color: var(--color-text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            width: 100%;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--shadow-focus);
        }
        button {
            background-color: var(--bg-button-primary);
            box-shadow: 0 4px 10px var(--shadow-button-primary);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        button:hover {
            background-color: var(--bg-button-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 15px var(--shadow-button-primary-hover);
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 0.3s ease-in-out;
            font-weight: 500;
        }
        .message-box.show {
            opacity: 1;
            top: 40px;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
        }
        th {
            background-color: var(--bg-table-header);
            font-weight: 600;
            color: var(--color-table-header);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr:nth-child(even) { background-color: var(--bg-table-row-even); }
        tr:hover { background-color: var(--bg-table-row-hover); }
        th:first-child { border-top-left-radius: 10px; }
        th:last-child { border-top-right-radius: 10px; }
        tr:last-child td:first-child { border-bottom-left-radius: 10px; }
        tr:last-child td:last-child { border-bottom-right-radius: 10px; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
            visibility: hidden; opacity: 0; transition: visibility 0s, opacity 0.4s ease-in-out;
        }
        .modal-overlay.show { visibility: visible; opacity: 1; }
        .modal-content {
            background-color: var(--bg-modal); padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); text-align: center;
            max-width: 400px; width: 90%; transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content { transform: translateY(0); }
        .modal-content .button-group { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-8">Digital Paraffin Log Sheet</h1>

        <h2 class="text-2xl font-bold text-center mb-6">Log New Entry</h2>
        <form id="logForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            
            <div>
                <label for="openingBowser" class="block text-sm font-medium mb-1">Opening Bowser</label>
                <input type="number" id="openingBowser" step="0.01" min="0" required>
            </div>
            <div>
                <label for="closingBowser" class="block text-sm font-medium mb-1">Closing Bowser</label>
                <input type="number" id="closingBowser" step="0.01" min="0" required>
            </div>
            <div>
                <label for="openingDipstick" class="block text-sm font-medium mb-1">Opening Dipstick</label>
                <input type="number" id="openingDipstick" step="0.01" min="0" required>
            </div>
            <div>
                <label for="closingDipstick" class="block text-sm font-medium mb-1">Closing Dipstick</label>
                <input type="number" id="closingDipstick" step="0.01" min="0" required>
            </div>

            <div>
                <label for="soh" class="block text-sm font-medium mb-1">Stock on Hand (SOH)</label>
                <input type="number" id="soh" step="0.01" min="0" required>
            </div>
            <div>
                <label for="countedBy" class="block text-sm font-medium mb-1">Counted By</label>
                <input type="text" id="countedBy" required>
            </div>
            
            <div>
                <label for="remark" class="block text-sm font-medium mb-1">Remark</label>
                <input type="text" id="remark">
            </div>

            <div class="col-span-full flex justify-center mt-4">
                <button type="submit" class="px-8 py-3">Save Log Entry</button>
            </div>
        </form>

        <div class="flex flex-wrap justify-center gap-3 mb-6">
            <button id="exportCsvBtn" class="px-6 py-2 bg-green-500 hover:bg-green-600">Export CSV</button>
            <button id="exportPdfBtn" class="px-6 py-2 bg-red-500 hover:bg-red-600">Export PDF</button>
            <button id="clearAllDataBtn" class="px-6 py-2 bg-gray-500 hover:bg-gray-600">Clear All Data</button>
        </div>
        <div class="overflow-x-auto rounded-lg shadow-sm mb-12">
            <table id="recordsTable" class="min-w-full">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Opening Bowser</th>
                        <th>Closing Bowser</th>
                        <th>Bowser Diff</th>
                        <th>Opening Dipstick</th>
                        <th>Closing Dipstick</th>
                        <th>Dip Diff</th>
                        <th>SOH</th>
                        <th>Counted By</th>
                        <th>Remark</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <p id="noRecordsMessage" class="text-center text-gray-500 py-4 hidden">No log entries found.</p>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Confirm Deletion</h3>
            <p id="modalMessage">Are you sure you want to delete ALL log entries? This action cannot be undone.</p>
            <div class="button-group">
                <button id="confirmDeleteBtn" class="confirm-btn bg-red-600 hover:bg-red-700">Yes, Delete All</button>
                <button id="cancelDeleteBtn" class="cancel-btn bg-gray-500 hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, getDocs, deleteDoc, doc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-8rm40H95HYpvWGdy6IY30OrNfuwNxCk",
            authDomain: "superb-hyper-1c75b.firebaseapp.com",
            projectId: "superb-hyper-1c75b",
            storageBucket: "superb-hyper-1c75b.firebasestorage.app",
            messagingSenderId: "879869345488",
            appId: "1:879869345488:web:9b38b8130ea8561ef528d5",
            measurementId: "G-JSYT6M60V5"
        };

        const appId = firebaseConfig.projectId;
        let db, auth;
        let currentLogRecords = [];

        function showMessageBox(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === 'success' ? 'var(--bg-message-success)' : 'var(--bg-message-error)';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 3000);
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, user => {
                if (user) {
                    listenForRecords();
                } else {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed", error));
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed", error);
            showMessageBox("Could not connect to the database.", 'error');
        }

        const logForm = document.getElementById('logForm');
        const recordsTableBody = document.querySelector('#recordsTable tbody');
        const noRecordsMessage = document.getElementById('noRecordsMessage');

        async function getLatestReadings() {
            if (!db) return null;
            const recordsCollection = collection(db, `artifacts/${appId}/public/data/paraffin_log_sheet`);
            const q = query(recordsCollection, orderBy("timestamp", "desc"), limit(1));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                return querySnapshot.docs[0].data();
            }
            return null;
        }

        async function setInitialValues() {
            const latestRecord = await getLatestReadings();
            if (latestRecord) {
                document.getElementById('openingBowser').value = latestRecord.closingBowser?.toFixed(2) || '';
                document.getElementById('openingDipstick').value = latestRecord.closingDipstick?.toFixed(2) || '';
            }
        }
        
        logForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const openingBowser = parseFloat(document.getElementById('openingBowser').value);
            const closingBowser = parseFloat(document.getElementById('closingBowser').value);
            const openingDipstick = parseFloat(document.getElementById('openingDipstick').value);
            const closingDipstick = parseFloat(document.getElementById('closingDipstick').value);

            if (closingBowser < openingBowser) {
                showMessageBox("Closing Bowser cannot be less than Opening Bowser.", 'error');
                return;
            }
             if (closingDipstick > openingDipstick) {
                showMessageBox("Closing Dipstick cannot be higher than Opening Dipstick.", 'error');
                return;
            }

            const newEntry = {
                openingBowser,
                closingBowser,
                bowserDiff: closingBowser - openingBowser,
                openingDipstick,
                closingDipstick,
                dipstickDiff: openingDipstick - closingDipstick,
                soh: parseFloat(document.getElementById('soh').value),
                countedBy: document.getElementById('countedBy').value.trim(),
                remark: document.getElementById('remark').value.trim(),
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/paraffin_log_sheet`), newEntry);
                showMessageBox("Log entry saved successfully!");
                logForm.reset();
                await setInitialValues();
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessageBox("Failed to save entry.", 'error');
            }
        });

        function listenForRecords() {
            if (!db) return;
            const q = query(collection(db, `artifacts/${appId}/public/data/paraffin_log_sheet`), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                currentLogRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayRecords(currentLogRecords);
                if (document.getElementById('openingBowser').value === '') {
                   setInitialValues();
                }
            }, (error) => console.error("Error listening to records:", error));
        }

        function displayRecords(records) {
            recordsTableBody.innerHTML = '';
            noRecordsMessage.classList.toggle('hidden', records.length > 0);
            records.forEach(record => {
                const row = recordsTableBody.insertRow();
                const date = record.timestamp ? new Date(record.timestamp.toDate()).toLocaleDateString() : 'N/A';
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${record.openingBowser?.toFixed(2)}</td>
                    <td>${record.closingBowser?.toFixed(2)}</td>
                    <td><b>${record.bowserDiff?.toFixed(2)}</b></td>
                    <td>${record.openingDipstick?.toFixed(2)}</td>
                    <td>${record.closingDipstick?.toFixed(2)}</td>
                    <td><b>${record.dipstickDiff?.toFixed(2)}</b></td>
                    <td>${record.soh?.toFixed(2)}</td>
                    <td>${record.countedBy}</td>
                    <td>${record.remark}</td>
                `;
            });
        }
        
        // Export and Clear Data Functionality
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const clearAllDataBtn = document.getElementById('clearAllDataBtn');
        const confirmationModal = document.getElementById('confirmationModal');

        function getExportData() {
            const headers = ["Date", "Opening Bowser", "Closing Bowser", "Bowser Diff", "Opening Dipstick", "Closing Dipstick", "Dip Diff", "SOH", "Counted By", "Remark"];
            const data = currentLogRecords.map(r => [
                r.timestamp ? new Date(r.timestamp.toDate()).toLocaleString() : 'N/A',
                r.openingBowser?.toFixed(2), r.closingBowser?.toFixed(2), r.bowserDiff?.toFixed(2),
                r.openingDipstick?.toFixed(2), r.closingDipstick?.toFixed(2), r.dipstickDiff?.toFixed(2),
                r.soh?.toFixed(2), r.countedBy, `"${r.remark.replace(/"/g, '""')}"`
            ]);
            return { headers, data };
        }

        exportCsvBtn.addEventListener('click', () => {
            if (currentLogRecords.length === 0) return showMessageBox("No data to export.", 'error');
            const { headers, data } = getExportData();
            const csvContent = [headers.join(','), ...data.map(row => row.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'paraffin_log_sheet.csv');
            link.click();
            link.remove();
        });

        exportPdfBtn.addEventListener('click', () => {
            if (currentLogRecords.length === 0) return showMessageBox("No data to export.", 'error');
            const { headers, data } = getExportData();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            doc.autoTable({ head: [headers], body: data, styles: { fontSize: 8 } });
            doc.save('paraffin_log_sheet.pdf');
        });

        clearAllDataBtn.addEventListener('click', () => confirmationModal.classList.add('show'));
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => confirmationModal.classList.remove('show'));
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            confirmationModal.classList.remove('show');
            const collectionPath = `artifacts/${appId}/public/data/paraffin_log_sheet`;
            const snapshot = await getDocs(collection(db, collectionPath));
            const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
            await Promise.all(deletePromises);
            showMessageBox("All data cleared successfully.", 'success');
            logForm.reset();
        });
    </script>
</body>
</html>